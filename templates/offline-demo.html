{% extends "base.html" %}

{% block title %}Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¶Ø¹ ØºÙŠØ± Ø§Ù„Ù…ØªØµÙ„ - Norko Store{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-wifi-off"></i>
                        Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ØºÙŠØ± Ø§Ù„Ù…ØªØµÙ„Ø©
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
                    <div class="alert alert-info">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span id="connectionIndicator" class="badge">
                                    <i class="bi bi-wifi"></i> ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„...
                                </span>
                            </div>
                            <div class="col">
                                <span id="connectionMessage">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ù„ÙŠ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
                            <div class="input-group mb-3">
                                <input type="text" id="productSearchTest" class="form-control" 
                                       placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
                                <button class="btn btn-primary" onclick="testProductSearch()">
                                    <i class="bi bi-search"></i> Ø¨Ø­Ø«
                                </button>
                            </div>
                            <div id="productSearchResults" class="border rounded p-3 bg-light" style="min-height: 100px;">
                                <small class="text-muted">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h5>
                            <div class="input-group mb-3">
                                <input type="text" id="customerSearchTest" class="form-control" 
                                       placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„...">
                                <button class="btn btn-primary" onclick="testCustomerSearch()">
                                    <i class="bi bi-search"></i> Ø¨Ø­Ø«
                                </button>
                            </div>
                            <div id="customerSearchResults" class="border rounded p-3 bg-light" style="min-height: 100px;">
                                <small class="text-muted">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</small>
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ø¨ÙŠØ¹ Ù…Ø­Ù„ÙŠ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ø¨ÙŠØ¹ Ù…Ø­Ù„ÙŠØ§Ù‹</h5>
                            <div class="card border-success">
                                <div class="card-body">
                                    <form onsubmit="testLocalSale(event)">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬</label>
                                                <select id="testProductSelect" class="form-select">
                                                    <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                                <input type="number" id="testQuantity" class="form-control" 
                                                       value="1" min="1">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Ø§Ù„Ø³Ø¹Ø±</label>
                                                <input type="number" id="testPrice" class="form-control" 
                                                       step="0.01" readonly>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="submit" class="btn btn-success">
                                                <i class="bi bi-cart-plus"></i> Ø­ÙØ¸ Ø¨ÙŠØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ø­Ù„ÙŠØ§Ù‹
                                            </button>
                                            <button type="button" class="btn btn-info ms-2" onclick="viewPendingOperations()">
                                                <i class="bi bi-list"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</h5>
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary" onclick="manualSync()">
                                    <i class="bi bi-arrow-clockwise"></i> Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©
                                </button>
                                <button class="btn btn-warning" onclick="clearLocalData()">
                                    <i class="bi bi-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                                </button>
                                <button class="btn btn-info" onclick="showStatus()">
                                    <i class="bi bi-info-circle"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© -->
                    <div class="row">
                        <div class="col-12">
                            <h5>Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h5>
                            <div id="activityLog" class="border rounded p-3 bg-dark text-light" 
                                 style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
                                <div class="text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-secondary" onclick="clearLog()">
                                    <i class="bi bi-x-circle"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-gear"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Service Worker:</td>
                            <td id="swStatus" class="text-muted">ÙØ­Øµ...</td>
                        </tr>
                        <tr>
                            <td>IndexedDB:</td>
                            <td id="idbStatus" class="text-muted">ÙØ­Øµ...</td>
                        </tr>
                        <tr>
                            <td>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</td>
                            <td id="onlineStatus" class="text-muted">ÙØ­Øµ...</td>
                        </tr>
                        <tr>
                            <td>Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©:</td>
                            <td id="lastSyncStatus" class="text-muted">ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-database"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</td>
                            <td id="localProductsCount" class="text-muted">0</td>
                        </tr>
                        <tr>
                            <td>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</td>
                            <td id="localCustomersCount" class="text-muted">0</td>
                        </tr>
                        <tr>
                            <td>Ø§Ù„ÙØ¦Ø§Øª:</td>
                            <td id="localCategoriesCount" class="text-muted">0</td>
                        </tr>
                        <tr>
                            <td>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:</td>
                            <td id="pendingOpsCount" class="text-muted">0</td>
                        </tr>
                    </table>
                    <button class="btn btn-sm btn-outline-primary w-100" onclick="refreshLocalStats()">
                        <i class="bi bi-arrow-clockwise"></i> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
            </div>

            <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-question-circle"></i> ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </h6>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li>ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹</li>
                        <li>Ø§ÙØªØ­ Developer Tools (F12)</li>
                        <li>Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Network</li>
                        <li>Ø§Ø®ØªØ± "Offline" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</li>
                        <li>Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹Ø§Øª</li>
                        <li>Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ±Ø§Ù‚Ø¨ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
<div id="testNotifications" class="position-fixed top-0 end-0 p-3" style="z-index: 1060;">
</div>

<script>
let logElement;
let initialized = false;

document.addEventListener('DOMContentLoaded', async function() {
    logElement = document.getElementById('activityLog');
    
    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†
    await waitForManagers();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    await initializePage();
    
    log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
    initialized = true;
});

async function waitForManagers() {
    log('â³ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠØ±ÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
    
    let attempts = 0;
    while ((!window.dbManager || !window.syncManager) && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (!window.dbManager || !window.syncManager) {
        log('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†');
        return false;
    }
    
    log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
    return true;
}

async function initializePage() {
    // ÙØ­Øµ Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­
    checkBrowserSupport();
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    updateConnectionStatus();
    
    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    await loadTestProducts();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    await refreshLocalStats();
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
}

function checkBrowserSupport() {
    const swSupported = 'serviceWorker' in navigator;
    const idbSupported = 'indexedDB' in window;
    
    document.getElementById('swStatus').innerHTML = swSupported ? 
        '<span class="text-success">Ù…Ø¯Ø¹ÙˆÙ…</span>' : 
        '<span class="text-danger">ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</span>';
        
    document.getElementById('idbStatus').innerHTML = idbSupported ? 
        '<span class="text-success">Ù…Ø¯Ø¹ÙˆÙ…</span>' : 
        '<span class="text-danger">ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…</span>';
    
    log(`ğŸ” ÙØ­Øµ Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­: SW=${swSupported}, IDB=${idbSupported}`);
}

function updateConnectionStatus() {
    const isOnline = navigator.onLine;
    const indicator = document.getElementById('connectionIndicator');
    const message = document.getElementById('connectionMessage');
    const status = document.getElementById('onlineStatus');
    
    if (isOnline) {
        indicator.className = 'badge bg-success';
        indicator.innerHTML = '<i class="bi bi-wifi"></i> Ù…ØªØµÙ„';
        message.textContent = 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ù…ØªØ§Ø­Ø©';
        status.innerHTML = '<span class="text-success">Ù…ØªØµÙ„</span>';
    } else {
        indicator.className = 'badge bg-warning';
        indicator.innerHTML = '<i class="bi bi-wifi-off"></i> ØºÙŠØ± Ù…ØªØµÙ„';
        message.textContent = 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…ØªØµÙ„ - Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©';
        status.innerHTML = '<span class="text-warning">ØºÙŠØ± Ù…ØªØµÙ„</span>';
    }
    
    log(`ğŸŒ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ${isOnline ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}`);
}

async function loadTestProducts() {
    try {
        const products = await window.dbManager.getProducts();
        const selectElement = document.getElementById('testProductSelect');
        
        selectElement.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬...</option>';
        
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name_ar} - ${product.retail_price} Ø¬.Ù…`;
            option.dataset.price = product.retail_price;
            selectElement.appendChild(option);
        });
        
        selectElement.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            document.getElementById('testPrice').value = selectedOption.dataset.price || '';
        });
        
        log(`ğŸ“¦ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${products.length} Ù…Ù†ØªØ¬ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±`);
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${error.message}`);
    }
}

async function testProductSearch() {
    const searchTerm = document.getElementById('productSearchTest').value.trim();
    const resultsDiv = document.getElementById('productSearchResults');
    
    if (!searchTerm) {
        resultsDiv.innerHTML = '<small class="text-muted">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«</small>';
        return;
    }
    
    try {
        log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: "${searchTerm}"`);
        const products = await window.dbManager.getProducts({ search: searchTerm });
        
        if (products.length === 0) {
            resultsDiv.innerHTML = '<small class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</small>';
        } else {
            resultsDiv.innerHTML = products.map(product => `
                <div class="border-bottom py-2">
                    <strong>${product.name_ar}</strong><br>
                    <small class="text-muted">Ø§Ù„Ø³Ø¹Ø±: ${product.retail_price} Ø¬.Ù… | Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${product.stock_quantity}</small>
                </div>
            `).join('');
        }
        
        log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${products.length} Ù…Ù†ØªØ¬`);
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${error.message}`);
        resultsDiv.innerHTML = `<small class="text-danger">Ø®Ø·Ø£: ${error.message}</small>`;
    }
}

async function testCustomerSearch() {
    const searchTerm = document.getElementById('customerSearchTest').value.trim();
    const resultsDiv = document.getElementById('customerSearchResults');
    
    if (!searchTerm) {
        resultsDiv.innerHTML = '<small class="text-muted">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«</small>';
        return;
    }
    
    try {
        log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: "${searchTerm}"`);
        const customers = await window.dbManager.getCustomers(searchTerm);
        
        if (customers.length === 0) {
            resultsDiv.innerHTML = '<small class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</small>';
        } else {
            resultsDiv.innerHTML = customers.map(customer => `
                <div class="border-bottom py-2">
                    <strong>${customer.name}</strong><br>
                    <small class="text-muted">Ø§Ù„Ù‡Ø§ØªÙ: ${customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
                </div>
            `).join('');
        }
        
        log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${customers.length} Ø¹Ù…ÙŠÙ„`);
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${error.message}`);
        resultsDiv.innerHTML = `<small class="text-danger">Ø®Ø·Ø£: ${error.message}</small>`;
    }
}

async function testLocalSale(event) {
    event.preventDefault();
    
    const productId = document.getElementById('testProductSelect').value;
    const quantity = parseFloat(document.getElementById('testQuantity').value);
    const price = parseFloat(document.getElementById('testPrice').value);
    
    if (!productId || !quantity || !price) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'warning');
        return;
    }
    
    try {
        log(`ğŸ’° Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ: Ù…Ù†ØªØ¬ ${productId}, ÙƒÙ…ÙŠØ© ${quantity}, Ø³Ø¹Ø± ${price}`);
        
        const saleData = {
            items: [{
                product_id: parseInt(productId),
                quantity: quantity,
                unit_price: price,
                total_price: quantity * price
            }],
            total_amount: quantity * price,
            payment_status: 'paid',
            payment_type: 'cash',
            notes: 'Ø¨ÙŠØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'
        };
        
        const saleId = await window.syncManager.saveSaleLocal(saleData);
        
        log(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø±Ù‚Ù…: ${saleId}`);
        showNotification(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹ Ø±Ù‚Ù… ${saleId} Ù…Ø­Ù„ÙŠØ§Ù‹`, 'success');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        await refreshLocalStats();
        
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹: ${error.message}`);
        showNotification(`Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹: ${error.message}`, 'error');
    }
}

async function viewPendingOperations() {
    try {
        const pendingOps = await window.dbManager.getPendingOperations();
        
        if (pendingOps.length === 0) {
            showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¹Ù„Ù‚Ø©', 'info');
            return;
        }
        
        log(`ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: ${pendingOps.length}`);
        pendingOps.forEach((op, index) => {
            log(`   ${index + 1}. ${op.operation_type} - ${new Date(op.timestamp).toLocaleString('ar-EG')}`);
        });
        
        showNotification(`ÙŠÙˆØ¬Ø¯ ${pendingOps.length} Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©`, 'info');
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: ${error.message}`);
    }
}

async function manualSync() {
    if (!navigator.onLine) {
        showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning');
        return;
    }
    
    try {
        log('ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©...');
        await window.syncManager.performSync();
        showNotification('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${error.message}`);
        showNotification(`ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${error.message}`, 'error');
    }
}

async function clearLocalData() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©ØŸ')) {
        try {
            log('ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
            await window.dbManager.clearAllData();
            await refreshLocalStats();
            log('âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'success');
        } catch (error) {
            log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            showNotification(`ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
        }
    }
}

async function showStatus() {
    try {
        const status = await window.syncManager.getStatus();
        log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:');
        log(`   Ø§Ù„Ø§ØªØµØ§Ù„: ${status.isOnline ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}`);
        log(`   Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ©: ${status.syncInProgress ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`);
        log(`   Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: ${status.lastSyncTime ? status.lastSyncTime.toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}`);
        log(`   Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©: ${status.pendingOperations}`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        document.getElementById('lastSyncStatus').textContent = 
            status.lastSyncTime ? status.lastSyncTime.toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
            
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©: ${error.message}`);
    }
}

async function refreshLocalStats() {
    try {
        const [products, customers, categories, pendingOps] = await Promise.all([
            window.dbManager.getProducts(),
            window.dbManager.getCustomers(),
            window.dbManager.getCategories(),
            window.dbManager.getPendingOperations()
        ]);
        
        document.getElementById('localProductsCount').textContent = products.length;
        document.getElementById('localCustomersCount').textContent = customers.length;
        document.getElementById('localCategoriesCount').textContent = categories.length;
        document.getElementById('pendingOpsCount').textContent = pendingOps.length;
        
        log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø­Ø¯Ù‘Ø«Ø©: ${products.length} Ù…Ù†ØªØ¬, ${customers.length} Ø¹Ù…ÙŠÙ„, ${categories.length} ÙØ¦Ø©, ${pendingOps.length} Ø¹Ù…Ù„ÙŠØ© Ù…Ø¹Ù„Ù‚Ø©`);
    } catch (error) {
        log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${error.message}`);
    }
}

function log(message) {
    if (!logElement) return;
    
    const timestamp = new Date().toLocaleTimeString('ar-EG');
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
    
    logElement.appendChild(logEntry);
    logElement.scrollTop = logElement.scrollHeight;
}

function clearLog() {
    if (logElement) {
        logElement.innerHTML = '<div class="text-muted">ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</div>';
    }
}

function showNotification(message, type = 'info') {
    const container = document.getElementById('testNotifications');
    const notification = document.createElement('div');
    
    const typeClasses = {
        success: 'alert-success',
        error: 'alert-danger',
        warning: 'alert-warning',
        info: 'alert-info'
    };
    
    notification.className = `alert ${typeClasses[type]} alert-dismissible fade show`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(notification);
    
    // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>

{% endblock %} 