{% extends "base.html" %}

{% block title %}مولد رموز QR{% endblock %}

{% block extra_head %}
<!-- Preload QR Code Libraries for Better Performance -->
<script async crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script async crossorigin="anonymous" src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
<script async crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h1 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>
                        مولد رموز QR
                    </h1>
                    <p class="mb-0 mt-2">أنشئ رموز QR لمواقع التواصل الاجتماعي والمواقع والهواتف</p>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>خيارات الحجم:</h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary size-btn"
                                    onclick="changeQRSize(150)">صغير</button>
                                <button type="button" class="btn btn-outline-secondary size-btn active"
                                    onclick="changeQRSize(200)">متوسط</button>
                                <button type="button" class="btn btn-outline-secondary size-btn"
                                    onclick="changeQRSize(300)">كبير</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>إعدادات العرض:</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showTitles" checked
                                    onchange="toggleTitles()">
                                <label class="form-check-label" for="showTitles">
                                    إظهار عناوين الرموز
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-success" onclick="fillSampleData()">
                                    <i class="fas fa-fill-drip"></i> ملء بيانات تجريبية
                                </button>
                                <button type="button" class="btn btn-info" onclick="regenerateAllQR()">
                                    <i class="fas fa-sync"></i> إنشاء جميع الرموز
                                </button>
                            </div>
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-primary" onclick="downloadAllQR()">
                                    <i class="fas fa-download"></i> تحميل الكل
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="printAllQR()">
                                    <i class="fas fa-print"></i> طباعة الكل
                                </button>
                                <button type="button" class="btn btn-warning" onclick="clearAllQR()">
                                    <i class="fas fa-eraser"></i> مسح الكل
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Generator Grid -->
    <div class="row">
        <!-- Facebook -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-primary text-white text-center">
                    <i class="fab fa-facebook-f me-2"></i>
                    <span class="qr-label">Facebook</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="facebook"
                            placeholder="https://facebook.com/your.page" onkeyup="generateQR('facebook')">
                    </div>
                    <div class="qr-title mb-2" id="facebook-title" style="display: none;">
                        <strong>Facebook</strong>
                    </div>
                    <div class="qr-code" id="facebook-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('facebook', 'Facebook')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- Instagram -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header text-white text-center"
                    style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);">
                    <i class="fab fa-instagram me-2"></i>
                    <span class="qr-label">Instagram</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="instagram"
                            placeholder="https://instagram.com/your_account" onkeyup="generateQR('instagram')">
                    </div>
                    <div class="qr-title mb-2" id="instagram-title" style="display: none;">
                        <strong>Instagram</strong>
                    </div>
                    <div class="qr-code" id="instagram-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('instagram', 'Instagram')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- WhatsApp -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-success text-white text-center">
                    <i class="fab fa-whatsapp me-2"></i>
                    <span class="qr-label">WhatsApp</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="tel" class="form-control qr-input" id="whatsapp" placeholder="+201234567890"
                            onkeyup="generateWhatsAppQR()">
                    </div>
                    <div class="qr-title mb-2" id="whatsapp-title" style="display: none;">
                        <strong>WhatsApp</strong>
                    </div>
                    <div class="qr-code" id="whatsapp-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('whatsapp', 'WhatsApp')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- Twitter/X -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-dark text-white text-center">
                    <i class="fab fa-twitter me-2"></i>
                    <span class="qr-label">Twitter/X</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="twitter"
                            placeholder="https://twitter.com/your_account" onkeyup="generateQR('twitter')">
                    </div>
                    <div class="qr-title mb-2" id="twitter-title" style="display: none;">
                        <strong>Twitter/X</strong>
                    </div>
                    <div class="qr-code" id="twitter-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('twitter', 'Twitter')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- YouTube -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-danger text-white text-center">
                    <i class="fab fa-youtube me-2"></i>
                    <span class="qr-label">YouTube</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="youtube"
                            placeholder="https://youtube.com/c/YourChannel" onkeyup="generateQR('youtube')">
                    </div>
                    <div class="qr-title mb-2" id="youtube-title" style="display: none;">
                        <strong>YouTube</strong>
                    </div>
                    <div class="qr-code" id="youtube-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('youtube', 'YouTube')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- LinkedIn -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header text-white text-center" style="background-color: #0077b5;">
                    <i class="fab fa-linkedin me-2"></i>
                    <span class="qr-label">LinkedIn</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="linkedin"
                            placeholder="https://linkedin.com/in/your-profile" onkeyup="generateQR('linkedin')">
                    </div>
                    <div class="qr-title mb-2" id="linkedin-title" style="display: none;">
                        <strong>LinkedIn</strong>
                    </div>
                    <div class="qr-code" id="linkedin-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('linkedin', 'LinkedIn')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- Telegram -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header text-white text-center" style="background-color: #229ed9;">
                    <i class="fab fa-telegram me-2"></i>
                    <span class="qr-label">Telegram</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="telegram"
                            placeholder="https://t.me/your_channel" onkeyup="generateQR('telegram')">
                    </div>
                    <div class="qr-title mb-2" id="telegram-title" style="display: none;">
                        <strong>Telegram</strong>
                    </div>
                    <div class="qr-code" id="telegram-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('telegram', 'Telegram')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- TikTok -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-dark text-white text-center">
                    <i class="fab fa-tiktok me-2"></i>
                    <span class="qr-label">TikTok</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="tiktok"
                            placeholder="https://tiktok.com/@your_account" onkeyup="generateQR('tiktok')">
                    </div>
                    <div class="qr-title mb-2" id="tiktok-title" style="display: none;">
                        <strong>TikTok</strong>
                    </div>
                    <div class="qr-code" id="tiktok-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('tiktok', 'TikTok')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- Website -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-info text-white text-center">
                    <i class="fas fa-globe me-2"></i>
                    <span class="qr-label">موقع إلكتروني</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="url" class="form-control qr-input" id="website"
                            placeholder="https://your-website.com" onkeyup="generateQR('website')">
                    </div>
                    <div class="qr-title mb-2" id="website-title" style="display: none;">
                        <strong>موقع إلكتروني</strong>
                    </div>
                    <div class="qr-code" id="website-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('website', 'Website')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- Phone -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-warning text-dark text-center">
                    <i class="fas fa-phone me-2"></i>
                    <span class="qr-label">رقم هاتف</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="tel" class="form-control qr-input" id="phone" placeholder="+201234567890"
                            onkeyup="generatePhoneQR()">
                    </div>
                    <div class="qr-title mb-2" id="phone-title" style="display: none;">
                        <strong>رقم هاتف</strong>
                    </div>
                    <div class="qr-code" id="phone-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('phone', 'Phone')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- Email -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-secondary text-white text-center">
                    <i class="fas fa-envelope me-2"></i>
                    <span class="qr-label">بريد إلكتروني</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <input type="email" class="form-control qr-input" id="email"
                            placeholder="your.email@example.com" onkeyup="generateEmailQR()">
                    </div>
                    <div class="qr-title mb-2" id="email-title" style="display: none;">
                        <strong>بريد إلكتروني</strong>
                    </div>
                    <div class="qr-code" id="email-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('email', 'Email')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>

        <!-- Custom Text -->
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="card qr-card h-100 shadow-sm">
                <div class="card-header bg-purple text-white text-center" style="background-color: #6f42c1;">
                    <i class="fas fa-edit me-2"></i>
                    <span class="qr-label">نص مخصص</span>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <textarea class="form-control qr-input" id="customText" rows="2"
                            placeholder="أدخل أي نص أو رابط..." onkeyup="generateCustomQR()"></textarea>
                    </div>
                    <div class="qr-title mb-2" id="custom-title" style="display: none;">
                        <strong>نص مخصص</strong>
                    </div>
                    <div class="qr-code" id="custom-qr"></div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQR('custom', 'Custom')">
                        <i class="fas fa-download"></i> تحميل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Long Text Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header text-white text-center"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-align-left me-2"></i>
                        نص طويل متعدد السطور
                    </h5>
                    <p class="mb-0 mt-1 small">مناسب للنصوص المطولة والمقالات والرسائل والمعلومات التفصيلية</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="longText" class="form-label fw-bold">
                                    <i class="fas fa-file-text text-primary"></i> اكتب النص الطويل هنا:
                                </label>
                                <textarea class="form-control qr-input" id="longText" rows="8"
                                    placeholder="يمكنك كتابة نص طويل هنا بعدة أسطر...&#10;&#10;مثال:&#10;• تفاصيل حدث أو مناسبة&#10;• عنوان مفصل مع التوجيهات&#10;• رسالة طويلة أو تهنئة&#10;• معلومات كاملة عن منتج&#10;• تعليمات أو إرشادات&#10;• أو أي محتوى تريد مشاركته بسهولة"
                                    onkeyup="generateLongTextQR()" onpaste="setTimeout(generateLongTextQR, 100)"
                                    style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; resize: vertical; min-height: 200px;"></textarea>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle text-info"></i>
                                    يدعم النص العربي والإنجليزي والأرقام والرموز الخاصة والأسطر المتعددة
                                </small>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <button type="button" class="btn btn-outline-info btn-sm"
                                        onclick="addSampleLongText()">
                                        <i class="fas fa-magic"></i> نص تجريبي
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm"
                                        onclick="clearLongText()">
                                        <i class="fas fa-eraser"></i> مسح النص
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm"
                                        onclick="copyToClipboard('longText')">
                                        <i class="fas fa-copy"></i> نسخ النص
                                    </button>
                                    <button type="button" class="btn btn-outline-dark btn-sm"
                                        onclick="pasteFromClipboard('longText')">
                                        <i class="fas fa-paste"></i> لصق
                                    </button>
                                    <span class="badge bg-secondary ms-2" id="charCount">0 حرف</span>
                                    <span class="badge bg-info" id="lineCount">0 سطر</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="qr-title mb-2" id="longtext-title" style="display: none;">
                                    <strong>النص الطويل</strong>
                                </div>
                                <div class="qr-code border rounded p-3" id="longtext-qr"
                                    style="min-height: 250px; background: #f8f9fa;">
                                    <div
                                        class="text-muted d-flex flex-column align-items-center justify-content-center h-100">
                                        <i class="fas fa-qrcode fa-3x mb-3 text-secondary"></i>
                                        <p class="small text-center">سيظهر رمز QR هنا<br>عند كتابة النص</p>
                                    </div>
                                </div>
                                <button class="btn btn-primary mt-3" onclick="downloadQR('longtext', 'LongText')"
                                    id="downloadLongTextBtn" style="display: none;">
                                    <i class="fas fa-download"></i> تحميل QR للنص الطويل
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
    @media print {
        .no-print {
            display: none !important;
        }

        .container-fluid {
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .row {
            margin: 0 !important;
        }

        .col-lg-3,
        .col-md-4,
        .col-sm-6 {
            width: 50% !important;
            max-width: 50% !important;
            flex: 0 0 50% !important;
            padding: 5px !important;
        }

        .card {
            break-inside: avoid;
            margin-bottom: 10px !important;
            box-shadow: none !important;
            border: 1px solid #ddd !important;
        }

        .card-header {
            background: #f8f9fa !important;
            color: #000 !important;
            border-bottom: 1px solid #ddd !important;
            padding: 5px 10px !important;
        }

        .card-body {
            padding: 10px !important;
        }

        .qr-code canvas,
        .qr-code img {
            max-width: 150px !important;
            height: auto !important;
        }

        .btn {
            display: none !important;
        }

        .form-control {
            display: none !important;
        }

        .qr-title {
            display: block !important;
            font-weight: bold !important;
            margin-bottom: 10px !important;
        }

        /* Long text section styling for print */
        .card:has(#longtext-qr) {
            page-break-inside: avoid;
            width: 100% !important;
            max-width: 100% !important;
        }

        #longtext-qr canvas,
        #longtext-qr img {
            max-width: 300px !important;
            height: auto !important;
        }
    }

    .qr-card:hover {
        transform: translateY(-2px);
        transition: transform 0.3s ease;
    }

    .qr-code {
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .size-btn.active {
        background-color: #007bff;
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // QR Library Management
    let qrLibraryReady = false;
    let currentQRSize = 200;

    // Load QR library with enhanced multiple fallbacks
    async function loadQRLibrary() {
        const libraries = [
            'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
            'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
            'https://cdn.skypack.dev/qrcode@1.5.3',
            'https://esm.sh/qrcode@1.5.3'
        ];

        // First check if QRCode is already available (cached)
        if (typeof QRCode !== 'undefined') {
            console.log('QRCode library already available');
            return true;
        }

        // Try loading from different CDNs
        for (let i = 0; i < libraries.length; i++) {
            const url = libraries[i];
            try {
                console.log(`📡 Attempting QR library load ${i + 1}/${libraries.length}: ${url}`);
                await loadScript(url, 6000); // Reduced timeout per source

                if (typeof QRCode !== 'undefined') {
                    console.log(`✅ QRCode library loaded successfully from: ${url}`);
                    return true;
                } else {
                    console.warn(`⚠️ Script loaded but QRCode not defined from: ${url}`);
                }
            } catch (error) {
                console.warn(`❌ Failed to load QR from source ${i + 1}: ${url}`, error.message);
            }

            // Small delay between attempts
            await new Promise(resolve => setTimeout(resolve, 200));
        }

        // If all CDNs fail, try alternative approaches
        console.warn('All CDN sources failed, attempting fallback creation...');

        try {
            const fallbackCreated = createSimpleFallback();
            if (fallbackCreated) {
                console.log('✅ Enhanced fallback QR system created successfully');
                return true;
            }
        } catch (error) {
            console.error('❌ Fallback creation failed:', error);
        }

        console.error('❌ All QR library loading methods failed');
        return false;
    }

    function loadScript(src, timeout = 8000) {
        return new Promise((resolve, reject) => {
            // Remove any existing script with same src to avoid conflicts
            const existingScript = document.querySelector(`script[src="${src}"]`);
            if (existingScript) {
                existingScript.remove();
                console.log('🔄 Removed existing script:', src);
            }

            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.crossOrigin = 'anonymous';

            let timeoutId;

            const cleanup = () => {
                if (timeoutId) clearTimeout(timeoutId);
                if (script.parentNode) script.parentNode.removeChild(script);
            };

            script.onload = () => {
                console.log('📄 Script loaded:', src);
                clearTimeout(timeoutId);
                // Give extra time for script execution and QRCode definition
                setTimeout(() => {
                    if (typeof QRCode !== 'undefined') {
                        console.log('✅ QRCode object confirmed after load');
                        resolve();
                    } else {
                        console.warn('⚠️ Script loaded but QRCode not available');
                        cleanup();
                        reject(new Error('QRCode not defined after script load'));
                    }
                }, 300);
            };

            script.onerror = (error) => {
                console.warn('❌ Script load error:', src, error);
                cleanup();
                reject(new Error(`Script load error: ${src}`));
            };

            // Set timeout
            timeoutId = setTimeout(() => {
                console.warn(`⏰ Script load timeout (${timeout}ms):`, src);
                cleanup();
                reject(new Error(`Script load timeout: ${src}`));
            }, timeout);

            try {
                document.head.appendChild(script);
                console.log('📡 Script injection started:', src);
            } catch (error) {
                cleanup();
                reject(error);
            }
        });
    }

    // Enhanced fallback using multiple QR APIs
    function createSimpleFallback() {
        window.QRCode = {
            toCanvas: function (container, text, options, callback) {
                const size = options.width || 200;
                const encodedText = encodeURIComponent(text);

                // Array of fallback APIs
                const qrAPIs = [
                    `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodedText}&format=png&margin=2&ecc=M`,
                    `https://qr.io/api/qr?data=${encodedText}&size=${size}&format=png`,
                    `https://quickchart.io/qr?text=${encodedText}&size=${size}`,
                    `https://chart.googleapis.com/chart?chs=${size}x${size}&cht=qr&chl=${encodedText}&choe=UTF-8`
                ];

                let currentAPIIndex = 0;

                function tryNextAPI() {
                    if (currentAPIIndex >= qrAPIs.length) {
                        // All APIs failed, show text fallback
                        container.innerHTML = `
                        <div style="width: ${size}px; height: ${size}px; border: 2px dashed #007bff; 
                                    display: flex; align-items: center; justify-content: center; 
                                    background: #f8f9fa; font-size: 12px; text-align: center; padding: 10px;
                                    border-radius: 8px; color: #495057;">
                            <div>
                                <i class="fas fa-qrcode fa-2x mb-2" style="color: #007bff;"></i><br>
                                <strong>QR Code</strong><br>
                                <small style="word-break: break-all;">${text.length > 40 ? text.substring(0, 40) + '...' : text}</small><br>
                                <small class="text-muted">مولد QR جاهز للاستخدام</small>
                            </div>
                        </div>
                    `;
                        if (callback) callback(null);
                        return;
                    }

                    const img = document.createElement('img');
                    img.src = qrAPIs[currentAPIIndex];
                    img.style.width = size + 'px';
                    img.style.height = size + 'px';
                    img.style.border = '1px solid #dee2e6';
                    img.style.borderRadius = '6px';
                    img.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    img.alt = 'QR Code';

                    img.onload = function () {
                        container.innerHTML = '';
                        container.appendChild(img);
                        console.log(`QR generated successfully using API ${currentAPIIndex + 1}: ${qrAPIs[currentAPIIndex]}`);
                        if (callback) callback(null);
                    };

                    img.onerror = function () {
                        console.warn(`QR API ${currentAPIIndex + 1} failed: ${qrAPIs[currentAPIIndex]}`);
                        currentAPIIndex++;
                        tryNextAPI();
                    };

                    // Set a timeout for each API attempt
                    setTimeout(() => {
                        if (img.complete === false) {
                            console.warn(`QR API ${currentAPIIndex + 1} timeout: ${qrAPIs[currentAPIIndex]}`);
                            currentAPIIndex++;
                            tryNextAPI();
                        }
                    }, 8000);
                }

                try {
                    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...</div>';
                    tryNextAPI();
                } catch (error) {
                    console.error('Fallback QR generation error:', error);
                    container.innerHTML = `
                    <div class="alert alert-warning p-2 small">
                        <i class="fas fa-exclamation-triangle"></i> 
                        خطأ في إنشاء QR
                    </div>
                `;
                    if (callback) callback(error);
                }
            }
        };

        console.log('Enhanced QR fallback system initialized with multiple APIs');
        return true;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function () {
        const alertContainer = document.querySelector('main .container-fluid');

        try {
            // Show detailed loading message
            showAlert('info', '<i class="fas fa-spinner fa-spin"></i> جاري تحضير مولد QR... يرجى الانتظار', 'qr-loading-alert');

            // Load QR library with detailed progress
            console.log('🚀 Starting QR library initialization...');
            const loaded = await loadQRLibrary();
            qrLibraryReady = loaded;

            // Remove loading message
            hideAlert('qr-loading-alert');

            if (loaded) {
                console.log('🎉 QR system fully initialized and ready');
                showAlert('success',
                    '<i class="fas fa-check-circle"></i> مولد QR جاهز للاستخدام! يمكنك الآن إنشاء رموز QR بسهولة.',
                    'qr-success-alert', 4000);
            } else {
                console.warn('⚠️ QR system initialized with limitations');
                showAlert('warning',
                    '<i class="fas fa-exclamation-triangle"></i> نظام QR يعمل بوضع محدود - ستعمل الوظائف الأساسية',
                    'qr-warning-alert', 6000);
            }

        } catch (error) {
            console.error('💥 Failed to initialize QR library:', error);
            hideAlert('qr-loading-alert');

            try {
                // Last resort fallback
                console.log('🔧 Attempting emergency fallback...');
                await createSimpleFallback();
                qrLibraryReady = true;
                showAlert('info',
                    '<i class="fas fa-tools"></i> تم تفعيل النظام البديل - الوظائف الأساسية متاحة',
                    'qr-fallback-alert', 5000);
            } catch (fallbackError) {
                console.error('💔 Emergency fallback also failed:', fallbackError);
                showAlert('danger',
                    '<i class="fas fa-times-circle"></i> تعذر تحميل نظام QR. يرجى إعادة تحميل الصفحة.',
                    'qr-error-alert', 8000);
                qrLibraryReady = false;
            }
        }

        toggleTitles();
    });

    // Alert helper functions
    function showAlert(type, message, id, autoHide = null) {
        const alertContainer = document.querySelector('main .container-fluid');
        if (!alertContainer) return;

        // Remove existing alert with same ID
        hideAlert(id);

        const alert = document.createElement('div');
        alert.id = id;
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        alertContainer.insertBefore(alert, alertContainer.firstChild);

        if (autoHide) {
            setTimeout(() => hideAlert(id), autoHide);
        }
    }

    function hideAlert(id) {
        const alert = document.getElementById(id);
        if (alert && alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }

    // Wait for QR library
    function waitForQRCode() {
        return new Promise((resolve) => {
            if (qrLibraryReady && typeof QRCode !== 'undefined') {
                resolve();
                return;
            }

            const checkInterval = setInterval(() => {
                if (qrLibraryReady && typeof QRCode !== 'undefined') {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 100);

            // Timeout after 30 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                resolve();
            }, 30000);
        });
    }

    // Generate QR code functions
    async function generateQR(platform) {
        const input = document.getElementById(platform);
        const qrContainer = document.getElementById(platform + '-qr');
        const titleElement = document.getElementById(platform + '-title');

        if (!input.value.trim()) {
            qrContainer.innerHTML = '';
            titleElement.style.display = 'none';
            return;
        }

        try {
            qrContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...</div>';
            await waitForQRCode();

            QRCode.toCanvas(qrContainer, input.value.trim(), {
                width: currentQRSize,
                height: currentQRSize,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('QR generation error:', error);
                    qrContainer.innerHTML = '<div class="alert alert-warning">خطأ في إنشاء QR</div>';
                } else {
                    titleElement.style.display = document.getElementById('showTitles').checked ? 'block' : 'none';
                }
            });
        } catch (error) {
            console.error('QR generation failed:', error);
            qrContainer.innerHTML = '<div class="alert alert-danger">فشل في إنشاء QR</div>';
        }
    }

    async function generateWhatsAppQR() {
        const input = document.getElementById('whatsapp');
        const qrContainer = document.getElementById('whatsapp-qr');
        const titleElement = document.getElementById('whatsapp-title');

        if (!input.value.trim()) {
            qrContainer.innerHTML = '';
            titleElement.style.display = 'none';
            return;
        }

        try {
            qrContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...</div>';
            await waitForQRCode();

            let phoneNumber = input.value.trim();
            phoneNumber = phoneNumber.replace(/[^\d+]/g, '');

            if (!phoneNumber.startsWith('+')) {
                phoneNumber = '+2' + phoneNumber;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber.replace('+', '')}`;

            QRCode.toCanvas(qrContainer, whatsappUrl, {
                width: currentQRSize,
                height: currentQRSize,
                margin: 2,
                color: {
                    dark: '#25d366',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('WhatsApp QR error:', error);
                    qrContainer.innerHTML = '<div class="alert alert-warning">خطأ في إنشاء QR للواتساب</div>';
                } else {
                    titleElement.style.display = document.getElementById('showTitles').checked ? 'block' : 'none';
                }
            });
        } catch (error) {
            console.error('WhatsApp QR failed:', error);
            qrContainer.innerHTML = '<div class="alert alert-danger">فشل في إنشاء QR للواتساب</div>';
        }
    }

    async function generatePhoneQR() {
        const input = document.getElementById('phone');
        const qrContainer = document.getElementById('phone-qr');
        const titleElement = document.getElementById('phone-title');

        if (!input.value.trim()) {
            qrContainer.innerHTML = '';
            titleElement.style.display = 'none';
            return;
        }

        try {
            qrContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...</div>';
            await waitForQRCode();

            const phoneUrl = `tel:${input.value.trim()}`;

            QRCode.toCanvas(qrContainer, phoneUrl, {
                width: currentQRSize,
                height: currentQRSize,
                margin: 2,
                color: {
                    dark: '#28a745',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('Phone QR error:', error);
                    qrContainer.innerHTML = '<div class="alert alert-warning">خطأ في إنشاء QR للهاتف</div>';
                } else {
                    titleElement.style.display = document.getElementById('showTitles').checked ? 'block' : 'none';
                }
            });
        } catch (error) {
            console.error('Phone QR failed:', error);
            qrContainer.innerHTML = '<div class="alert alert-danger">فشل في إنشاء QR للهاتف</div>';
        }
    }

    async function generateEmailQR() {
        const input = document.getElementById('email');
        const qrContainer = document.getElementById('email-qr');
        const titleElement = document.getElementById('email-title');

        if (!input.value.trim()) {
            qrContainer.innerHTML = '';
            titleElement.style.display = 'none';
            return;
        }

        try {
            qrContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...</div>';
            await waitForQRCode();

            const emailUrl = `mailto:${input.value.trim()}`;

            QRCode.toCanvas(qrContainer, emailUrl, {
                width: currentQRSize,
                height: currentQRSize,
                margin: 2,
                color: {
                    dark: '#dc3545',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('Email QR error:', error);
                    qrContainer.innerHTML = '<div class="alert alert-warning">خطأ في إنشاء QR للإيميل</div>';
                } else {
                    titleElement.style.display = document.getElementById('showTitles').checked ? 'block' : 'none';
                }
            });
        } catch (error) {
            console.error('Email QR failed:', error);
            qrContainer.innerHTML = '<div class="alert alert-danger">فشل في إنشاء QR للإيميل</div>';
        }
    }

    async function generateCustomQR() {
        const input = document.getElementById('customText');
        const qrContainer = document.getElementById('custom-qr');

        if (!input.value.trim()) {
            qrContainer.innerHTML = '';
            return;
        }

        try {
            qrContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...</div>';
            await waitForQRCode();

            QRCode.toCanvas(qrContainer, input.value.trim(), {
                width: currentQRSize,
                height: currentQRSize,
                margin: 2,
                color: {
                    dark: '#6f42c1',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('Custom QR error:', error);
                    qrContainer.innerHTML = '<div class="alert alert-warning">خطأ في إنشاء QR المخصص</div>';
                }
            });
        } catch (error) {
            console.error('Custom QR failed:', error);
            qrContainer.innerHTML = '<div class="alert alert-danger">فشل في إنشاء QR المخصص</div>';
        }
    }

    // Generate QR for long text
    async function generateLongTextQR() {
        const input = document.getElementById('longText');
        const qrContainer = document.getElementById('longtext-qr');
        const titleElement = document.getElementById('longtext-title');
        const downloadBtn = document.getElementById('downloadLongTextBtn');

        // Update character and line counters
        updateTextCounters();

        if (!input.value.trim()) {
            qrContainer.innerHTML = `
                <div class="text-muted d-flex flex-column align-items-center justify-content-center h-100">
                    <i class="fas fa-qrcode fa-3x mb-3 text-secondary"></i>
                    <p class="small text-center">سيظهر رمز QR هنا<br>عند كتابة النص</p>
                </div>
            `;
            titleElement.style.display = 'none';
            downloadBtn.style.display = 'none';
            return;
        }

        try {
            qrContainer.innerHTML = '<div class="text-center d-flex flex-column align-items-center justify-content-center h-100"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>جاري إنشاء QR للنص الطويل...</p></div>';
            await waitForQRCode();

            QRCode.toCanvas(qrContainer, input.value.trim(), {
                width: currentQRSize,
                height: currentQRSize,
                margin: 2,
                errorCorrectionLevel: 'M', // Medium error correction for long text
                color: {
                    dark: '#4a5568',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error('Long text QR error:', error);
                    qrContainer.innerHTML = '<div class="alert alert-warning p-2"><small>خطأ في إنشاء QR للنص الطويل<br>جرب تقليل طول النص</small></div>';
                } else {
                    titleElement.style.display = document.getElementById('showTitles').checked ? 'block' : 'none';
                    downloadBtn.style.display = 'inline-block';
                }
            });
        } catch (error) {
            console.error('Long text QR failed:', error);
            qrContainer.innerHTML = '<div class="alert alert-danger p-2"><small>فشل في إنشاء QR للنص الطويل</small></div>';
        }
    }

    // Update character and line counters
    function updateTextCounters() {
        const input = document.getElementById('longText');
        const charCount = document.getElementById('charCount');
        const lineCount = document.getElementById('lineCount');

        if (input && charCount && lineCount) {
            const text = input.value;
            const chars = text.length;
            const lines = text.split('\n').length;

            charCount.textContent = `${chars} حرف`;
            lineCount.textContent = `${lines} سطر`;

            // Change badge color based on text length
            charCount.className = chars > 1000 ? 'badge bg-warning ms-2' : 'badge bg-secondary ms-2';
        }
    }

    // Add sample long text
    function addSampleLongText() {
        const longTextArea = document.getElementById('longText');
        const sampleText = `مرحباً بكم في مكتبتنا الرقمية

هذا مثال على نص طويل متعدد السطور يمكن تحويله إلى رمز QR للمشاركة السريعة.

معلومات المكتبة:
• الاسم: مكتبة المعرفة الرقمية
• العنوان: شارع التعليم، حي الثقافة، المدينة
• الهاتف: +966-11-1234567
• البريد الإلكتروني: info@library.com

أوقات العمل:
- السبت إلى الأربعاء: 8:00 ص - 10:00 م
- الخميس: 8:00 ص - 6:00 م
- الجمعة: مغلق

الخدمات المتاحة:
✓ استعارة الكتب والمراجع
✓ قاعات الدراسة والبحث
✓ الوصول للمكتبة الرقمية
✓ خدمات الطباعة والتصوير
✓ ورش العمل والدورات التدريبية

نتطلع لخدمتكم!`;

        longTextArea.value = sampleText;
        generateLongTextQR();
    }

    // Clear long text
    function clearLongText() {
        if (confirm('هل أنت متأكد من مسح النص الطويل؟')) {
            const longTextArea = document.getElementById('longText');
            longTextArea.value = '';
            generateLongTextQR();
        }
    }

    // Copy text to clipboard
    async function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (element && element.value) {
            try {
                await navigator.clipboard.writeText(element.value);
                showAlert('success', '<i class="fas fa-check"></i> تم نسخ النص إلى الحافظة', 'copy-alert', 2000);
            } catch (error) {
                console.error('Failed to copy text:', error);
                // Fallback for older browsers
                element.select();
                document.execCommand('copy');
                showAlert('info', '<i class="fas fa-check"></i> تم نسخ النص', 'copy-alert', 2000);
            }
        } else {
            showAlert('warning', '<i class="fas fa-exclamation"></i> لا يوجد نص لنسخه', 'copy-alert', 2000);
        }
    }

    // Paste from clipboard
    async function pasteFromClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            try {
                const text = await navigator.clipboard.readText();
                element.value = text;
                if (elementId === 'longText') {
                    generateLongTextQR();
                }
                showAlert('success', '<i class="fas fa-check"></i> تم لصق النص من الحافظة', 'paste-alert', 2000);
            } catch (error) {
                console.error('Failed to paste text:', error);
                showAlert('warning', '<i class="fas fa-exclamation"></i> فشل في لصق النص', 'paste-alert', 2000);
            }
        }
    }

    // Change QR size
    function changeQRSize(size) {
        currentQRSize = size;

        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        regenerateAllQR();
    }

    // Regenerate all QR codes
    async function regenerateAllQR() {
        if (!qrLibraryReady) {
            showAlert('warning', 'مولد QR غير جاهز بعد', 'temp-alert', 3000);
            return;
        }

        try {
            const platforms = ['facebook', 'instagram', 'twitter', 'youtube', 'linkedin', 'tiktok', 'telegram', 'website'];

            for (const platform of platforms) {
                const input = document.getElementById(platform);
                if (input && input.value.trim()) {
                    await generateQR(platform);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            await generateWhatsAppQR();
            await new Promise(resolve => setTimeout(resolve, 200));
            await generatePhoneQR();
            await new Promise(resolve => setTimeout(resolve, 200));
            await generateEmailQR();
            await new Promise(resolve => setTimeout(resolve, 200));
            await generateCustomQR();
            await new Promise(resolve => setTimeout(resolve, 200));
            await generateLongTextQR();

        } catch (error) {
            console.error('Error regenerating QR codes:', error);
            showAlert('danger', 'خطأ في إعادة إنشاء الرموز', 'temp-alert', 3000);
        }
    }

    // Toggle titles visibility
    function toggleTitles() {
        const showTitles = document.getElementById('showTitles').checked;
        const titles = document.querySelectorAll('.qr-title');

        titles.forEach(title => {
            title.style.display = showTitles ? 'block' : 'none';
        });
    }

    // Download QR code
    function downloadQR(platform, name) {
        const qrContainer = document.getElementById(platform + '-qr');
        const canvas = qrContainer.querySelector('canvas');
        const img = qrContainer.querySelector('img');

        if (canvas) {
            try {
                const link = document.createElement('a');
                link.download = `${name}_QR.png`;
                link.href = canvas.toDataURL();
                link.click();
            } catch (error) {
                console.error('Canvas download error:', error);
                alert('حدث خطأ في تحميل الملف');
            }
        } else if (img) {
            try {
                // For images from QR Server API, we need to handle cross-origin
                const link = document.createElement('a');
                link.download = `${name}_QR.png`;
                link.href = img.src;
                link.target = '_blank';
                link.click();
            } catch (error) {
                console.error('Image download error:', error);
                // Fallback: open in new tab
                window.open(img.src, '_blank');
            }
        } else {
            alert('يجب إنشاء QR أولاً');
        }
    }

    // Print all QR codes
    function printAllQR() {
        const qrCodes = document.querySelectorAll('.qr-code canvas, .qr-code img');
        if (qrCodes.length === 0) {
            alert('لا توجد رموز QR للطباعة. يرجى إنشاء بعض الرموز أولاً.');
            return;
        }

        window.print();
    }

    // Clear all QR codes
    function clearAllQR() {
        if (confirm('هل أنت متأكد من مسح جميع رموز QR؟')) {
            const inputs = document.querySelectorAll('.qr-input');
            inputs.forEach(input => {
                input.value = '';
            });

            const qrContainers = document.querySelectorAll('.qr-code');
            qrContainers.forEach(container => {
                container.innerHTML = '';
            });

            const titles = document.querySelectorAll('.qr-title');
            titles.forEach(title => {
                title.style.display = 'none';
            });

            // Clear character counters
            const charCount = document.getElementById('charCount');
            const lineCount = document.getElementById('lineCount');
            if (charCount) charCount.textContent = '0 حرف';
            if (lineCount) lineCount.textContent = '0 سطر';

            // Hide download button for long text
            const downloadBtn = document.getElementById('downloadLongTextBtn');
            if (downloadBtn) downloadBtn.style.display = 'none';
        }
    }

    // Download all QR codes
    function downloadAllQR() {
        const qrContainers = document.querySelectorAll('.qr-code');
        let downloadCount = 0;

        qrContainers.forEach((container, index) => {
            const canvas = container.querySelector('canvas');
            const img = container.querySelector('img');

            if (canvas || img) {
                setTimeout(() => {
                    try {
                        const link = document.createElement('a');
                        const parent = container.closest('.qr-card');
                        const label = parent.querySelector('.qr-label').textContent;
                        link.download = `${label}_QR_${index + 1}.png`;

                        if (canvas) {
                            link.href = canvas.toDataURL();
                        } else if (img) {
                            link.href = img.src;
                            link.target = '_blank';
                        }

                        link.click();
                        downloadCount++;
                    } catch (error) {
                        console.error(`Download error for QR ${index + 1}:`, error);
                    }
                }, index * 500);
            }
        });

        if (downloadCount === 0) {
            alert('لا توجد رموز QR للتحميل');
        }
    }

    // Fill sample data
    async function fillSampleData() {
        document.getElementById('facebook').value = 'https://facebook.com/your.page';
        document.getElementById('instagram').value = 'https://instagram.com/your_account';
        document.getElementById('whatsapp').value = '+201234567890';
        document.getElementById('twitter').value = 'https://twitter.com/your_account';
        document.getElementById('youtube').value = 'https://youtube.com/c/YourChannel';
        document.getElementById('website').value = 'https://your-website.com';
        document.getElementById('phone').value = '+201234567890';
        document.getElementById('email').value = 'your.email@example.com';
        document.getElementById('linkedin').value = 'https://linkedin.com/in/your-profile';
        document.getElementById('telegram').value = 'https://t.me/your_channel';
        document.getElementById('tiktok').value = 'https://tiktok.com/@your_account';
        document.getElementById('customText').value = 'مرحباً! هذا نص تجريبي لـ QR مخصص';

        // Add sample long text
        addSampleLongText();

        // Wait a bit for form to update, then regenerate
        setTimeout(async () => {
            await regenerateAllQR();
        }, 500);
    }
</script>
{% endblock %}